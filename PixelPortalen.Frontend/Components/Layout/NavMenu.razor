@inject CartService CartService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<nav class="navbar navbar-expand-md navbar-dark pp-bb">
    <button id="ToggleNavbarButton" class="navbar-toggler ms-auto me-2" type="button" 
            data-bs-toggle="collapse" data-bs-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
            <li class="nav-item">
                <NavLink id="homeTab" class="nav-link d-flex align-items-center" href="/" Match="NavLinkMatch.All">
                    <img src="images/PixelPortalenLogga.png" width="100" height="60" />
                </NavLink>
            </li>
            <AuthorizeView>
                <Authorized>
                    <li class="nav-item">
                        <NavLink id="logoutButton" class="nav-link d-flex align-items-center" @onclick="Logout">
                            Logga ut
                            @* @context.User.FindFirst("role")?.Value! *@
                        </NavLink>
                    </li>
                    <li class="nav-item">
                        <NavLink id="profileTab" class="nav-link d-flex align-items-center" href="profile">
                            @* <i class="bi bi-person-circle fs-4"></i> *@
                            Profil
                        </NavLink>
                    </li>
                </Authorized>
                <NotAuthorized>
                    <li class="nav-item">
                        <NavLink id="loginTab" class="nav-link d-flex align-items-center" href="login">
                            Logga in
                        </NavLink>
                    </li>
                </NotAuthorized>
            </AuthorizeView>
            <AuthorizeView Roles="Admin">
                <Authorized>
                    <li class="nav-item">
                        <NavLink id="usersTab" class="nav-link d-flex align-items-center" href="adminpage">
                            Admin
                            @* <i class="bi bi-gear-fill fs-4"></i> *@
                        </NavLink>
                    </li>
                </Authorized>
            </AuthorizeView>
        </ul>

        <ul class="navbar-nav">
            <li class="nav-item">
                <NavLink id="productTab" class="nav-link d-flex align-items-center" href="products">
                    Produkter
                </NavLink>
            </li>
            <li class="nav-item">
                <NavLink id="aboutTab" class="nav-link d-flex align-items-center" href="about">
                    Om Oss
                </NavLink>
            </li>
            <li class="nav-item">
                <a class="nav-link d-flex align-items-start text-white"
                        id="CartOffcanvasButton"
                        data-bs-toggle="offcanvas"
                        data-bs-target="#cartOffcanvas"
                        aria-controls="cartOffcanvas">
                    <i class="bi bi-cart4 fs-4 me-1"></i>
                    <span class="badge text-bg-info">@CartService.GetCartCount()</span>
                </a>
            </li>
        </ul>
    </div>
</nav>

@code {
    protected override void OnInitialized()
    {
        CartService.OnChange += UpdateCartCount;
    }

    private void UpdateCartCount()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        CartService.OnChange -= UpdateCartCount;
    }

    private async Task Logout()
    {
        ((CustomAuthStateProvider)AuthStateProvider).MarkUserAsLoggedOut();
        await AuthStateProvider.GetAuthenticationStateAsync();

        Navigation.NavigateTo("/", forceLoad: true);
    }
}